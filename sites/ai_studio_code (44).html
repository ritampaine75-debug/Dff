<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Air Paint</title>
    <!-- MediaPipe Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/vision_bundle.js" crossorigin="anonymous"></script>
    <style>
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; background: #000; font-family: sans-serif; 
        }

        #container { position: relative; width: 100vw; height: 100vh; }

        /* Full screen video and canvas */
        #webcam, #drawCanvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover; /* Ensures it fills screen without small popup look */
            transform: scaleX(-1); /* Mirrors the camera */
        }

        #drawCanvas { z-index: 2; pointer-events: none; }
        #webcam { z-index: 1; opacity: 0.4; }

        /* UI Elements */
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; text-align: center; padding: 20px;
        }

        .controls {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 50; display: flex; gap: 15px;
        }

        button {
            padding: 15px 30px; font-size: 18px; border-radius: 50px;
            border: none; background: #007bff; color: white; font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        #clearBtn { background: #ff4757; }
        
        .loading-spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 2s linear infinite; margin-bottom: 20px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- Startup Overlay (Crucial for Mobile Permissions) -->
    <div id="overlay">
        <div id="loader" class="loading-spinner"></div>
        <h2 id="statusText">Loading AI Model...</h2>
        <p>Please wait a few seconds</p>
        <button id="startBtn" style="display:none;">Start Drawing</button>
    </div>

    <div id="container">
        <video id="webcam" autoplay playsinline></video>
        <canvas id="drawCanvas"></canvas>
        
        <div class="controls">
            <button id="clearBtn">Clear</button>
        </div>
    </div>

<script type="module">
    import { HandLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3";

    const video = document.getElementById("webcam");
    const canvas = document.getElementById("drawCanvas");
    const ctx = canvas.getContext("2d");
    const overlay = document.getElementById("overlay");
    const startBtn = document.getElementById("startBtn");
    const statusText = document.getElementById("statusText");
    const loader = document.getElementById("loader");

    let handLandmarker = undefined;
    let lastVideoTime = -1;
    let lastPoint = null;

    // 1. Initialize AI Model
    async function setupModel() {
        try {
            const vision = await FilesetResolver.forVisionTasks(
                "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
            );
            handLandmarker = await HandLandmarker.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: `https://storage.googleapis.com/mediapipe-tasks/hand_landmarker/hand_landmarker.task`,
                    delegate: "GPU"
                },
                runningMode: "VIDEO",
                numHands: 1
            });
            
            // UI Update
            loader.style.display = "none";
            statusText.innerText = "Model Ready!";
            startBtn.style.display = "block";
        } catch (error) {
            statusText.innerText = "Error loading AI. Refresh page.";
            console.error(error);
        }
    }

    // 2. Start Camera and App
    async function startApp() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { 
                    facingMode: "user",
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            });
            video.srcObject = stream;
            
            overlay.style.display = "none";
            
            // Set canvas size correctly
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            video.addEventListener("loadeddata", predictWebcam);
        } catch (err) {
            alert("Camera access denied or not found.");
        }
    }

    // 3. AI Detection Loop
    async function predictWebcam() {
        if (video.currentTime !== lastVideoTime) {
            lastVideoTime = video.currentTime;
            const startTimeMs = performance.now();
            const results = handLandmarker.detectForVideo(video, startTimeMs);

            if (results.landmarks && results.landmarks.length > 0) {
                // Landmark 8 is Index Finger Tip
                const finger = results.landmarks[0][8];
                
                // Map coordinates (Note: scaleX(-1) mirrors X)
                const x = finger.x * canvas.width;
                const y = finger.y * canvas.height;

                draw(x, y);
            } else {
                lastPoint = null; // Finger lifted/lost
            }
        }
        requestAnimationFrame(predictWebcam);
    }

    // 4. Drawing function
    function draw(x, y) {
        ctx.strokeStyle = "#00FFCC"; // Only one color
        ctx.lineWidth = 10;
        ctx.lineCap = "round";
        ctx.lineJoin = "round";

        if (lastPoint) {
            ctx.beginPath();
            ctx.moveTo(lastPoint.x, lastPoint.y);
            ctx.lineTo(x, y);
            ctx.stroke();
        }
        lastPoint = { x, y };
    }

    // Buttons
    startBtn.addEventListener("click", startApp);
    document.getElementById("clearBtn").addEventListener("click", () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    });

    // Handle screen rotation
    window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    });

    setupModel();
</script>
</body>
</html>